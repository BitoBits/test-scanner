<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Binance Perpetuals Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
  <div id="root"></div>
  
  <script type="module">
    const TIMEFRAMES = ['15m', '1h', '4h', '12h', '1d'];
    const ALERT_FEEDS = [
      { id: 'feed1', name: '15m + 1h', timeframes: ['15m', '1h'] },
      { id: 'feed2', name: '4h + 12h', timeframes: ['4h', '12h'] },
      { id: 'feed3', name: '1D', timeframes: ['1d'] }
    ];

    const storage = {
      async get(key) {
        try {
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        } catch (e) {
          return null;
        }
      },
      async set(key, value) {
        try {
          localStorage.setItem(key, value);
          return { key, value };
        } catch (e) {
          return null;
        }
      }
    };

    class Scanner {
      constructor() {
        this.state = {
          loading: false,
          progress: { current: 0, total: 0 },
          initialized: false,
          alerts: { feed1: [], feed2: [], feed3: [] },
          pausedFeeds: { feed1: false, feed2: false, feed3: false },
          showInfo: false,
          lastFetch: {},
          symbols: []
        };
        this.wsRefs = [];
        this.lastOIData = {};
        this.audioEl = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS78OScTgwOTqXh8LdjHAU2jNXxzn0vBSh+zPDaklALFF7A7+mlVRIIQ5zd8sFuIwUqgM3y2Ik3CBhju+/gnE4MDU6l4fC3YxwFOIzV8c59LwUofszw2pJQCxNewO/ppVUSCEOc3fLBbiMFKoDN8tmJNwgYY7vv4JxODA1OpeHwt2McBTiM1fHOfS8FKH7M8NqSUAsUXsDv6aVVEghDnN3ywW4jBSqAzfLZiTcIGGO77+CcTgwNTqXh8LdjHAU4jNXxzn0vBSh+zPDaklALFF7A7+mlVRIIQ5zd8sFuIwUqgM3y2Yk3CBhju+/gnE4MDU6l4fC3YxwFOIzV8c59LwUofszw2pJQCxRewO/ppVUSCEOc3fLBbiMFKoDN8tmJNwgYY7vv4JxODA1OpeHwt2McBTiM1fHOfS8FKH7M8NqSUAsUXsDv6aVVEghDnN3ywW4jBSqAzfLZiTcIGGO77+CcTgwNTqXh8LdjHAU4jNXxzn0vBSh+zPDaklALFF7A7+mlVRIIQ5zd8sFuIwUqgM3y2Yk3CBhju+/gnE4MDU6l4fC3YxwFOIzV8c59LwUofszw2pJQCxRewO/ppVUSCEOc3fLBbiMFKoDN8tmJNwgYY7vv4JxODA1OpeHwt2McBTiM1fHOfS8FKH7M8NqSUAsUXsDv6aVVEghDnN3ywW4jBSqAzfLZiTcIGGO77+CcTgwNTqXh8LdjHAU4jNXxzn0vBSh+zPDaklALFF7A7+mlVRIIQ5zd8sFuIwUqgM3y2Yk3CBhju+/gnE4MDU6l4fC3YxwFOIzV8c59LwUofszw2pJQCxRewO/ppVUSCEOc3fLBbiMFKoDN8tmJNwgYY7vv4JxODA1OpeHwt2McBTiM1fHOfS8FKH7M8NqSUAsUXsDv6aVVEghDnN3ywW4jBSqAzfLZiTcIGGO77+CcTgwNTqXh8LdjHAU4jNXxzn0vBSh+zPDaklALFF7A7+mlVRIIQ5zd8sFuIwUqgM3y');
        this.init();
      }

      async init() {
        await this.loadStoredData();
        this.render();
        if (this.state.initialized && this.state.symbols.length > 0) {
          this.startOIPolling();
        }
      }

      async loadStoredData() {
        try {
          const stored = await storage.get('scanner-init');
          if (stored) {
            const data = JSON.parse(stored.value);
            this.state.initialized = data.initialized;
            this.state.lastFetch = data.lastFetch || {};
            this.state.symbols = data.symbols || [];
          }
        } catch (error) {
          console.log('No stored data found');
        }
      }

      startOIPolling() {
        setInterval(() => this.pollOpenInterest(), 300000);
        this.pollOpenInterest();
      }

      async pollOpenInterest() {
        if (!this.state.symbols || this.state.symbols.length === 0) return;
        
        for (const symbol of this.state.symbols.slice(0, 50)) {
          try {
            await new Promise(resolve => setTimeout(resolve, 100));
            const response = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${symbol}`);
            const data = await response.json();
            
            if (data.openInterest) {
              const currentOI = parseFloat(data.openInterest);
              const prevOI = this.lastOIData[symbol];
              
              if (prevOI && prevOI > 0) {
                const oiChangePercent = ((currentOI - prevOI) / prevOI) * 100;
                if (Math.abs(oiChangePercent) > 5) {
                  this.addAlert('feed1', {
                    symbol,
                    type: 'oiChange',
                    subtype: 'Significant OI Change',
                    value: oiChangePercent.toFixed(2) + '%',
                    timeframe: '5m',
                    timestamp: new Date()
                  });
                }
              }
              this.lastOIData[symbol] = currentOI;
            }
          } catch (error) {
            console.error(`Error polling OI for ${symbol}:`, error);
          }
        }
      }

      async initializeScanner() {
        console.log('Initialize button clicked');
        this.state.loading = true;
        this.state.progress = { current: 0, total: 0 };
        this.render();

        try {
          const exchangeInfo = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json());
          const perpetuals = exchangeInfo.symbols
            .filter(s => s.contractType === 'PERPETUAL' && !s.symbol.includes('_'))
            .map(s => s.symbol);

          this.state.symbols = perpetuals;
          this.state.progress.total = perpetuals.length * TIMEFRAMES.length;
          this.render();

          const fetchData = {};
          const extremesDB = {};

          for (const symbol of perpetuals) {
            extremesDB[symbol] = {};

            for (const tf of TIMEFRAMES) {
              try {
                await new Promise(resolve => setTimeout(resolve, 35));
                const klines = await fetch(
                  `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=100`
                ).then(r => r.json());

                if (!Array.isArray(klines)) continue;

                const processed = klines.map(k => ({
                  time: k[0],
                  volume: parseFloat(k[5]),
                  candleSize: ((parseFloat(k[2]) - parseFloat(k[3])) / parseFloat(k[3])) * 100
                }));

                const volumeSorted = [...processed].sort((a, b) => b.volume - a.volume);
                const candleSorted = [...processed].sort((a, b) => b.candleSize - a.candleSize);

                extremesDB[symbol][tf] = {
                  volume: { top5: volumeSorted.slice(0, 5) },
                  candleSize: { top5: candleSorted.slice(0, 5) }
                };

                fetchData[`${symbol}_${tf}`] = new Date().toISOString();
                this.state.progress.current++;
                this.render();
              } catch (error) {
                console.error(`Error fetching ${symbol} ${tf}:`, error);
              }
            }
          }

          await storage.set('scanner-extremes', JSON.stringify(extremesDB));
          await storage.set('scanner-init', JSON.stringify({
            initialized: true,
            lastFetch: fetchData,
            symbols: perpetuals
          }));

          this.state.lastFetch = fetchData;
          this.state.initialized = true;
          this.state.loading = false;
          this.render();
          this.startLiveMonitoring(perpetuals);
        } catch (error) {
          console.error('Initialization error:', error);
          alert('Error: ' + error.message);
          this.state.loading = false;
          this.render();
        }
      }

      startLiveMonitoring(symbolsList) {
        this.wsRefs.forEach(ws => ws.close());
        this.wsRefs = [];

        const streams = [];
        symbolsList.slice(0, 200).forEach(symbol => {
          TIMEFRAMES.forEach(tf => streams.push(`${symbol.toLowerCase()}@kline_${tf}`));
        });

        const ws = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams.join('/')}`);
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.data && data.data.k && data.data.k.x) this.processCandle(data.data);
        };
        this.wsRefs.push(ws);
      }

      async processCandle(klineData) {
        const { s: symbol, k } = klineData;
        const { i: interval, h: high, l: low, v: volume, T: closeTime } = k;
        const candleSize = ((parseFloat(high) - parseFloat(low)) / parseFloat(low)) * 100;
        const vol = parseFloat(volume);

        const extremesData = await storage.get('scanner-extremes');
        if (!extremesData) return;

        const extremesDB = JSON.parse(extremesData.value);
        if (!extremesDB[symbol] || !extremesDB[symbol][interval]) return;

        const extremes = extremesDB[symbol][interval];

        if (vol > 0 && extremes.volume.top5.length > 0) {
          const top5Vol = extremes.volume.top5;
          if (vol > top5Vol[4].volume) {
            const rank = top5Vol.filter(v => vol > v.volume).length + 1;
            this.addAlert(ALERT_FEEDS.find(f => f.timeframes.includes(interval))?.id, {
              symbol,
              type: 'volume',
              subtype: `Top 5 Volume: #${rank}`,
              value: vol.toFixed(2),
              timeframe: interval,
              timestamp: new Date(closeTime)
            });
          }
        }

        if (candleSize > 0 && extremes.candleSize.top5.length > 0) {
          const top5Candle = extremes.candleSize.top5;
          if (candleSize > top5Candle[4].candleSize) {
            const rank = top5Candle.filter(c => candleSize > c.candleSize).length + 1;
            this.addAlert(ALERT_FEEDS.find(f => f.timeframes.includes(interval))?.id, {
              symbol,
              type: 'candleSize',
              subtype: `Top 5 Candle Size: #${rank}`,
              value: candleSize.toFixed(2) + '%',
              timeframe: interval,
              timestamp: new Date(closeTime)
            });
          }
        }
      }

      addAlert(feedId, alert) {
        if (!feedId || this.state.pausedFeeds[feedId]) return;
        this.state.alerts[feedId] = [alert, ...this.state.alerts[feedId]].slice(0, 100);
        this.audioEl.play().catch(e => console.log('Audio play failed'));
        this.render();
      }

      toggleFeedPause(feedId) {
        this.state.pausedFeeds[feedId] = !this.state.pausedFeeds[feedId];
        this.render();
      }

      render() {
        const root = document.getElementById('root');
        const s = this.state;
        
        root.innerHTML = `
          <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold">Binance Perpetuals Scanner</h1>
          </div>

          ${!s.initialized ? `
            <div class="flex flex-col items-center justify-center mt-20">
              <button onclick="scanner.initializeScanner()" ${s.loading ? 'disabled' : ''} 
                class="px-8 py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded-lg text-lg font-semibold">
                ${s.loading ? 'Initializing...' : 'Initialize Scanner'}
              </button>
              ${s.loading ? `
                <div class="mt-8 w-96 bg-gray-800 rounded-lg p-4">
                  <div class="text-center mb-2">
                    Loading ${s.progress.current}/${s.progress.total} (${Math.round((s.progress.current / s.progress.total) * 100)}%)
                  </div>
                  <div class="w-full bg-gray-700 rounded-full h-4">
                    <div class="bg-blue-600 h-4 rounded-full transition-all" 
                      style="width: ${(s.progress.current / s.progress.total) * 100}%"></div>
                  </div>
                  <div class="text-xs text-gray-400 mt-2 text-center">
                    This will take 3-5 minutes. Fetching historical data...
                  </div>
                </div>
              ` : ''}
            </div>
          ` : `
            <div class="grid grid-cols-3 gap-4">
              ${ALERT_FEEDS.map(feed => `
                <div class="bg-gray-800 rounded-lg p-4">
                  <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">${feed.name}</h2>
                    <button onclick="scanner.toggleFeedPause('${feed.id}')" 
                      class="p-2 bg-gray-700 hover:bg-gray-600 rounded">
                      ${s.pausedFeeds[feed.id] ? '▶' : '⏸'}
                    </button>
                  </div>
                  <div class="space-y-2 max-h-[600px] overflow-y-auto">
                    ${s.alerts[feed.id].length === 0 ? `
                      <div class="text-gray-500 text-sm text-center py-8">
                        No alerts yet. Monitoring live...
                      </div>
                    ` : s.alerts[feed.id].map(alert => `
                      <div class="bg-gray-900 rounded p-3 text-sm border-l-4 border-yellow-500">
                        <div class="flex items-start justify-between">
                          <span class="font-bold">${alert.symbol}</span>
                          <span class="text-gray-400 text-xs">${alert.timeframe}</span>
                        </div>
                        <div class="mt-1 text-yellow-400">${alert.subtype}</div>
                        <div class="mt-1 text-gray-300">Value: ${alert.value}</div>
                        <div class="mt-1 text-gray-500 text-xs">
                          ${alert.timestamp.toLocaleString()}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        `;
      }
    }

    const scanner = new Scanner();
    window.scanner = scanner;
  </script>
</body>
</html>
